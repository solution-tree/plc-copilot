flowchart TB
  %% ============================================================
  %% PLC Coach Service — MVP Architecture (PRD v3)
  %% Zone A only · No UI · Single endpoint · Async ingestion
  %%
  %% LEGEND
  %%   Solid arrows (-->) = Query flow (numbered 1–4)
  %%   Dotted arrows (-.->) = Ingestion flow (prefixed i1–i6)
  %%   Thin dotted lines (-.-) = Security / observability
  %% ============================================================

  %% ========== Entry Points ==========
  CLIENT["Client / API Consumer"]:::entry
  TRIGGER["run_ingestion.py<br/>--book-sku SKU"]:::entry

  CLIENT -->|"HTTPS + Static API Key"| ALB

  %% ========== AWS VPC ==========
  subgraph VPC["AWS VPC"]
    direction TB

    ALB["Application Load Balancer<br/>(public subnet, TLS 1.2+)"]:::entry

    %% -------- Compute Services --------
    subgraph COMPUTE["ECS Fargate — Compute Services (private subnets)"]
      direction LR
      API["API Service<br/>FastAPI + Pydantic<br/>POST /api/v1/query<br/>LlamaIndex in-process"]:::svc
      RERANKER["Re-Ranker<br/>ms-marco-MiniLM-L-6-v2<br/>(self-hosted)"]:::svc
      PARSER["PDF Parser<br/>llmsherpa / nlm-ingestor<br/>(self-hosted)"]:::svc
      INGEST["Ingestion Worker<br/>(triggered Fargate task)"]:::svc
    end

    %% -------- Data Stores --------
    subgraph DATA["Data Stores (private subnets)"]
      direction LR
      QDRANT[("Qdrant · EC2<br/>plc_copilot_v1<br/>3,072-D vectors")]:::datastore
      PG[("PostgreSQL · RDS<br/>books · chunks<br/>audit_logs")]:::datastore
      REDIS[("Redis · ElastiCache<br/>Session state<br/>(clarification loop)")]:::datastore
      S3[("S3 · Private Bucket<br/>25 PLC source PDFs")]:::datastore
    end

    %% -------- Egress --------
    NAT["NAT Gateway<br/>(controlled egress)"]:::net

    %% -------- Security & Observability --------
    subgraph SEC["Security & Observability"]
      direction LR
      SECRETS["Secrets Manager<br/>API keys · DB creds"]:::obs
      KMS["KMS<br/>Encryption at rest"]:::obs
      CW["CloudWatch<br/>Structured JSON logs"]:::obs
      XRAY["X-Ray<br/>Distributed tracing"]:::obs
    end
  end

  %% ========== External Services ==========
  subgraph EXT["External Services — OpenAI API (zero-retention DPA)"]
    direction LR
    GPT4O["GPT-4o<br/>Generation<br/>Ambiguity detection<br/>Metadata extraction"]:::ext
    EMBED["text-embedding-3-large<br/>Semantic embeddings"]:::ext
    VISION["GPT-4o Vision<br/>Landscape page processing"]:::ext
  end

  %% ============================================================
  %% QUERY FLOW — solid arrows, numbered steps
  %% Client -> ALB -> API -> analysis -> search -> rerank -> generate
  %% ============================================================

  ALB -->|"route request"| API

  %% Step 1: Query analysis (ambiguity detection + metadata filter extraction)
  API -->|"1 · query analysis"| GPT4O

  %% Step 2a: If ambiguous — store session, return clarification question
  API <-->|"2a · session state<br/>(if ambiguous)"| REDIS

  %% Step 2b: If clear — hybrid search (semantic + keyword)
  API -->|"2b · semantic search"| QDRANT
  API -->|"2b · keyword search"| PG

  %% Step 3: Re-rank combined search results
  API -->|"3 · rank candidates"| RERANKER
  RERANKER -->|"3 · scored results"| API

  %% Step 4: Answer generation from top-ranked chunks
  API -->|"4 · answer generation"| GPT4O

  %% Audit logging
  API -->|"audit log"| PG

  %% ============================================================
  %% INGESTION FLOW — dotted arrows, i-prefixed steps
  %% Trigger -> fetch PDF -> classify -> parse/vision -> embed -> store
  %% ============================================================

  TRIGGER -.->|"trigger task"| INGEST

  %% i1: Fetch source PDF from S3
  INGEST -.->|"i1 · fetch PDF"| S3

  %% i2: Classify pages with PyMuPDF, parse portrait pages with llmsherpa
  INGEST -.->|"i2 · portrait pages<br/>(PyMuPDF classifies first)"| PARSER

  %% i3: Landscape pages rendered as images, processed by GPT-4o Vision
  INGEST -.->|"i3 · landscape pages"| VISION

  %% i4: Generate embeddings for all parsed chunks
  INGEST -.->|"i4 · embed chunks"| EMBED

  %% i5: Store vectors + metadata payload in Qdrant
  INGEST -.->|"i5 · store vectors"| QDRANT

  %% i6: Store chunk text + relational metadata in PostgreSQL
  INGEST -.->|"i6 · store metadata"| PG

  %% ============================================================
  %% EGRESS — all external traffic routes through NAT Gateway
  %% ============================================================

  NAT ---|"all external traffic"| EXT

  %% ============================================================
  %% SECURITY & OBSERVABILITY — non-directional dotted lines
  %% ============================================================

  API -.- SECRETS
  INGEST -.- SECRETS
  API -.- CW
  API -.- XRAY
  INGEST -.- CW
  QDRANT -.- KMS
  PG -.- KMS
  S3 -.- KMS
  REDIS -.- KMS

  %% ============================================================
  %% STYLES
  %% ============================================================

  classDef entry fill:#d4edda,stroke:#28a745,stroke-width:2px,color:#155724
  classDef svc fill:#cce5ff,stroke:#004085,stroke-width:2px,color:#004085
  classDef datastore fill:#fff3cd,stroke:#856404,stroke-width:2px,color:#856404
  classDef ext fill:#e2e3e5,stroke:#383d41,stroke-width:2px,color:#383d41
  classDef obs fill:#e8d5f5,stroke:#6f42c1,stroke-width:2px,color:#3b0764
  classDef net fill:#d1ecf1,stroke:#0c5460,stroke-width:2px,color:#0c5460
